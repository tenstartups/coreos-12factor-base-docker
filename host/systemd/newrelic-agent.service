[Unit]
Description=NewRelic system monitor agent service

[Service]
Restart=always
EnvironmentFile=<%= getenv!(:parasite_config_directory) %>/env/systemd.env
ExecStartPre=-/opt/bin/send-notification warn "Starting `<%= getenv!(:systemd_service_name) %>` docker container"
ExecStartPre=-/opt/bin/docker-check-pull ${PARASITE_DOCKER_IMAGE_NEWRELIC_AGENT}
ExecStartPre=-/opt/bin/docker-check-remove <%= getenv!(:systemd_service_name) %>
ExecStart=/usr/bin/docker run \
  --privileged \
  --pid host \
  --net host \
  -v /sys:/sys \
  -v /dev:/dev \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -e NRSYSMOND_license_key=${NEWRELIC_LICENSE_KEY} \
  -e NRSYSMOND_logfile=stdout \
  -e NRSYSMOND_loglevel=info \
  --name <%= getenv!(:systemd_service_name) %> \
  ${PARASITE_DOCKER_IMAGE_NEWRELIC_AGENT}
ExecStartPost=/opt/bin/docker-wait-container <%= getenv!(:systemd_service_name) %>
ExecStop=/usr/bin/docker stop <%= getenv!(:systemd_service_name) %>
