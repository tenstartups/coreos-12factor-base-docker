[Unit]
Description=NewRelic system monitor agent service

[Service]
Restart=always
EnvironmentFile=<%= getenv!(:parasite_config_directory) %>/env/systemd.env
Environment=DOCKER_CONTAINER_NAME=%n
ExecStartPre=-/opt/bin/send-notification warn "Starting `${DOCKER_CONTAINER_NAME}` docker container"
ExecStartPre=-/opt/bin/docker-check-pull ${DOCKER_IMAGE_NEWRELIC_AGENT}
ExecStartPre=-/opt/bin/docker-check-remove ${DOCKER_CONTAINER_NAME}
ExecStart=/usr/bin/docker run \
  --privileged \
  --pid host \
  --net host \
  -v /sys:/sys \
  -v /dev:/dev \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -e NRSYSMOND_license_key=${NEWRELIC_LICENSE_KEY} \
  -e NRSYSMOND_logfile=stdout \
  -e NRSYSMOND_loglevel=info \
  --name ${DOCKER_CONTAINER_NAME} \
  ${DOCKER_IMAGE_NEWRELIC_AGENT}
ExecStartPost=/opt/bin/docker-wait-container ${DOCKER_CONTAINER_NAME}
ExecStop=/usr/bin/docker stop ${DOCKER_CONTAINER_NAME}
